  
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"DMS Demo Stack",
   "Parameters":{  
      "StackEnv":{  
         "Type":"String",
         "Default":"st",
         "Description":"Environment",
         "AllowedValues":[  
            "st",
            "it",
            "pt"
         ]
      },
      "AMI":{  
         "Default":"ami-6871a115",
         "Description":"redhat ami",
         "Type":"String"
      },
      "VolumeSize":{  
         "Default":"10",
         "Description":"Size of EBS Vloume",
         "Type":"String"
      },
      "AvailabilityZones":{  
         "Default":"us-east-1a",
         "Description":"Comma separated list of availability zones for DB Tier (MUST MATCH Subnets Parameter)",
         "Type":"CommaDelimitedList"
      },
      "InstanceType":{  
         "Default":"t2.micro",
         "Description":"Size of instance",
         "Type":"String"
      },
      "AlertTopic":{  
         "Default":"arn:aws:sns:us-east-1:YOURSNSARN",
         "Description":"Arn for SNS Topic to use for Alerts",
         "Type":"String"
      },
      "SecurityGroups":{  
         "Default":"sg-xxxxx",
         "Description":"Comma separated list of security groups to apply to instances.",
         "Type":"CommaDelimitedList"
      },
      "ELBSubnets":{  
         "Default":"subnet-xxxxx",
         "Description":"Comma separate list of subnets (AT LEAST 3) to use for DB Tier",
         "Type":"CommaDelimitedList"
      },
      "PoolSubnets":{  
         "Default":"subnet-xxxxx",
         "Description":"Comma separate list of subnets (AT LEAST 3) to use for DB Tier",
         "Type":"CommaDelimitedList"
      },
      "InstanceName":{  
         "Default":"demo-stack",
         "Description":"Name of instances in AWS",
         "Type":"String"
      },
      "ELBName":{  
         "Default":"demo-ELB",
         "Description":"Name of ELB Resource in AWS",
         "Type":"String"
      },
      "ASGMaxSize":{  
         "Default":"1",
         "Description":"Maximum size of Autoscaling group",
         "Type":"String"
      },
      "ASGDesiredSize":{  
         "Default":"1",
         "Description":"Desired size of Autoscaling group",
         "Type":"String"
      },
      "ASGMinSize":{  
         "Default":"1",
         "Description":"Minimum size of Autoscaling group",
         "Type":"String"
      },
      "HealthCheck":{  
         "Default":"TCP:22",
         "Description":"Heath Check for instances",
         "Type":"String"
      },
      "DeviceName":{  
         "Default":"/dev/sda1",
         "Description":"Change depending on OS used",
         "Type":"String"
      },
      "KeyName":{  
         "Description":"Name of an existing EC2 KeyPair to enable SSH access to the instance",
         "Default":"yourKeyName",
         "Type":"AWS::EC2::KeyPair::KeyName"
      }
   },
   "Resources":{  
      "ELBPROPERTIES":{  
         "Properties":{  
            "ConnectionSettings":{  
               "IdleTimeout":1800
            },
            "CrossZone":"true",
            "HealthCheck":{  
               "HealthyThreshold":"2",
               "Interval":10,
               "Target":{  
                  "Ref":"HealthCheck"
               },
               "Timeout":"5",
               "UnhealthyThreshold":"10"
            },
            "Instances":[  

            ],
            "Listeners":[  
               {  
                  "InstancePort":"8080",
                  "InstanceProtocol":"HTTP",
                  "LoadBalancerPort":"80",
                  "Protocol":"HTTP"
               },
               {  
                  "InstancePort":"22",
                  "InstanceProtocol":"TCP",
                  "LoadBalancerPort":"22",
                  "Protocol":"TCP"
               }
            ],
            "LoadBalancerName":{  
               "Fn::Join":[  
                  "-",
                  [  
                     {  
                        "Ref":"ELBName"
                     },
                     {  
                        "Ref":"StackEnv"
                     }
                  ]
               ]
            },
            "Scheme":"internal",
            "SecurityGroups":{  
               "Ref":"SecurityGroups"
            },
            "Subnets":{  
               "Ref":"ELBSubnets"
            }
         },
         "Type":"AWS::ElasticLoadBalancing::LoadBalancer"
      },
      "LaunchConfig":{  
         "Properties":{  
            "AssociatePublicIpAddress":"true",
            "KeyName":{  
               "Ref":"KeyName"
            },
            "ImageId":{  
               "Ref":"AMI"
            },
            "InstanceType":{  
               "Ref":"InstanceType"
            },
            "BlockDeviceMappings":[  
               {  
                  "DeviceName":{  
                     "Ref":"DeviceName"
                  },
                  "Ebs":{  
                     "DeleteOnTermination":"true",
                     "VolumeSize":{  
                        "Ref":"VolumeSize"
                     }
                  }
               }
            ],
            "SecurityGroups":{  
               "Ref":"SecurityGroups"
            },
            "UserData":{  
               "Fn::Base64":{  
                  "Fn::Join":[  
                     "\n",
                     [  
                        "#!/bin/bash",
                        "",
                        "export AWS_DEFAULT_REGION=us-east-1 \n",
                        ""
                     ]
                  ]
               }
            }
         },
         "Type":"AWS::AutoScaling::LaunchConfiguration"
      },
      "ASG":{  
         "Properties":{  
            "AvailabilityZones":{  
               "Ref":"AvailabilityZones"
            },
            "DesiredCapacity":1,
            "HealthCheckGracePeriod":300,
            "HealthCheckType":"ELB",
            "LaunchConfigurationName":{  
               "Ref":"LaunchConfig"
            },
            "LoadBalancerNames":[  
               {  
                  "Ref":"ELBPROPERTIES"
               }
            ],
            "MaxSize":"2",
            "MinSize":"1",
            "NotificationConfiguration":{  
               "NotificationTypes":[  
                  "autoscaling:EC2_INSTANCE_LAUNCH",
                  "autoscaling:EC2_INSTANCE_LAUNCH_ERROR",
                  "autoscaling:EC2_INSTANCE_TERMINATE",
                  "autoscaling:EC2_INSTANCE_TERMINATE_ERROR"
               ],
               "TopicARN":{  
                  "Ref":"AlertTopic"
               }
            },
            "Tags":[  
               {  
                  "Key":"Name",
                  "PropagateAtLaunch":true,
                  "Value":{  
                     "Fn::Join":[  
                        "-",
                        [  
                           {  
                              "Ref":"InstanceName"
                           },
                           {  
                              "Ref":"StackEnv"
                           }
                        ]
                     ]
                  }
               }
            ],
            "VPCZoneIdentifier":{  
               "Ref":"PoolSubnets"
            }
         },
         "Type":"AWS::AutoScaling::AutoScalingGroup"
      }
   }
}
